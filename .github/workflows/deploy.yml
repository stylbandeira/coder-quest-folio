name: ðŸš€ Deploy to HostGator via SFTP

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸšš Checkout code
        uses: actions/checkout@v4

      - name: âŽ” Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ—ï¸ Build project
        run: npm run build

      - name: ðŸ” Find build folder
        run: |
          if [ -d "dist" ]; then
            echo "BUILD_FOLDER=dist" >> $GITHUB_ENV
          elif [ -d "build" ]; then
            echo "BUILD_FOLDER=build" >> $GITHUB_ENV
          else
            echo "âŒ Nenhuma pasta de build encontrada!"
            exit 1
          fi
          echo "ðŸ“ Pasta de build: ${{ env.BUILD_FOLDER }}"

      - name: ðŸ”§ Create .htaccess
        run: |
          cat > ${{ env.BUILD_FOLDER }}/.htaccess << 'EOF'
          RewriteEngine On
          RewriteBase /
          RewriteRule ^index\.html$ - [L]
          RewriteCond %{REQUEST_FILENAME} !-f
          RewriteCond %{REQUEST_FILENAME} !-d
          RewriteRule . /index.html [L]
          EOF

      - name: ðŸ“¤ Deploy via SFTP
        uses: easingthemes/ssh-deploy@v4.1.8
        with:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_PORT: ${{ secrets.REMOTE_PORT }}
          SOURCE: ${{ env.BUILD_FOLDER }}/
          TARGET: ${{ secrets.REMOTE_TARGET }}

      - name: âœ… Verify deployment
        run: |
          echo "ðŸŽ‰ Deploy concluÃ­do via SFTP!"
          echo "ðŸŒ Acesse: https://stylbandeira.com"
