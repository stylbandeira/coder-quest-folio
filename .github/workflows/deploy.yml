name: 🚀 Deploy to HostGator via SFTP

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 🚚 Checkout code
        uses: actions/checkout@v4

      - name: ⎔ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: 📦 Install dependencies
        run: npm ci

      - name: 🏗️ Build project
        run: npm run build

      - name: 🔍 Find build folder
        run: |
          if [ -d "dist" ]; then
            echo "BUILD_FOLDER=dist" >> $GITHUB_ENV
          elif [ -d "build" ]; then
            echo "BUILD_FOLDER=build" >> $GITHUB_ENV
          else
            echo "❌ Nenhuma pasta de build encontrada!"
            exit 1
          fi
          echo "📁 Pasta de build: ${{ env.BUILD_FOLDER }}"

      - name: 🔧 Create .htaccess
        run: |
          cat > ${{ env.BUILD_FOLDER }}/.htaccess << 'EOF'
          RewriteEngine On
          RewriteBase /
          RewriteRule ^index\.html$ - [L]
          RewriteCond %{REQUEST_FILENAME} !-f
          RewriteCond %{REQUEST_FILENAME} !-d
          RewriteRule . /index.html [L]
          EOF

      - name: 📤 Deploy via SFTP
        uses: easingthemes/ssh-deploy@v4.1.8
        with:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_PORT: ${{ secrets.REMOTE_PORT }}
          SOURCE: ${{ env.BUILD_FOLDER }}/
          TARGET: ${{ secrets.REMOTE_TARGET }}

      - name: ✅ Verify deployment
        run: |
          echo "🎉 Deploy concluído via SFTP!"
          echo "🌐 Acesse: https://stylbandeira.com"
